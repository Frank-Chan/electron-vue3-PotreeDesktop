<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="./libs/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="./libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="./libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="./libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="./libs/jstree/themes/mixed/style.css">

	<style>

		.droproot{
			display: none;
			pointer-events: none;
			opacity: 0.7;
			position: absolute; 
			width:100%; 
			height: 100%; 
			z-index: 1000000;
		}

		.dropzone{
			border: 1em solid black;
			background: white;
		}

		.dropzone:before{
			 display: block;
  			position: absolute;
			border: 0.4em solid red;
			border-style: dashed;
			background: white;
			opacity: 0.8;
			content: " ";
			top: 1em;
			left: 1em;
			right: 1em;
			bottom: 1em;
		}

		.middle {
			position: absolute;
			left: 50%;
			top: 50%;
			-webkit-transform: translate(-50%, -50%);
			transform: translate(-50%, -50%);
			/* pointer-events: none; */
		}

		.center{
			left: 50%;
			-webkit-transform: translate(-50%, -0%);
			transform: translate(-50%, -0%);
		}

		.dropzone_title{
			font-size: 3vw;
			font-family: Arial;
			font-weight: bold;
			white-space: nowrap;
			text-align: center;
		}

		.dropzone_text{
			font-size: 1.4vw;
			font-family: Arial;
			font-weight: bold;
			white-space: nowrap;
		}

		#drop * {pointer-events: none;}

		#converter_panel{
			position: absolute; margin: auto; z-index: 2000000;
			background: white;
			border: 0.2em solid black;
			border-radius: 1em;
			padding: 1em;
			display: none;
		}

		#converter_panel .h2{
			text-align: center !important; 
			font-weight: bold;
			font-family: arial;
			font-size: 1.5em;
		}

		.converter_panel_list{
			max-height: 100px;
			overflow: auto;
			border: 1px solid black;
		}


		#converter_panel a:link{
			color: blue;
		}

		#converter_panel a:visited{
			color: blueviolet;
		}

		#converter_panel a:hover a:focus{
			color: blue;
		}

		#converter_panel a:active{
			color: blue;
		}




		.selection_buttons{
			display: flex;
		}

		.selection_buttons label {
			flex: 1;
			display: block;
			position: relative;
			margin: 0;
			padding: 1em;
			cursor: pointer;
			background-color: #ccc;
			border: 1px solid black;
			opacity: 0.3;

		}

		.selection_buttons input[type="radio"] {
			display: none;
		}

		.selection_buttons input[type="radio"]:hover+label {
			opacity: 0.5;
			z-index: 1000;
			box-shadow: 0 0 0 1pt black;
		}

		.selection_buttons input[type="radio"]:checked+label {
			opacity: 1.0;
			box-shadow: 0 0 0 1pt black;
		}

		.selection_buttons li{
			font-family: Arial;
			font-size: 1em;
		}

		.selection_buttons .title {
			font-family: Arial;
			font-weight: bold;
			font-size: 1.5em;
			width:100%;
			text-align: center;
			left: 50%;
			transform: translateX(-50%);
		}

		.selection_buttons .left{
			border-radius: 1em 0em 0em 1em;
		}

		.selection_buttons .right{
			border-radius: 0em 1em 1em 0em;
		}

		.converter_panel_widget{
			margin: 10px 0px;
		}


	</style>
</head>

<body>

	<span id="pointcloud_file_dropzone" class="droproot">
		<span style="position:absolute; left: 0px; right: 0px; top: 0px; bottom: 0px" class="dropzone">
			
			<span class="middle">
				<p class="dropzone_title">Convert and/or Load point clouds</p>

				<ul class="dropzone_text">
					<li>Drop LAS/LAZ files to convert and load them.</li>
					<li>Drop folders to convert and load all files inside.</li>
					<li>Drop previously converted cloud.js, metadata.json or containing directy to load.</li>
				</ul>
			</span>

		</span>
	</span>

	<span id="converter_panel" class="middle">

		<div class="converter_panel_widget">
			Target Directory: <br>
			<span style="display: flex">
				<input id="converter_panel_target_directory" type="textfield" style="flex-grow: 1">
				<!-- <span style="width: 0.2em"></span>
				<input id="converter_panel_pick_target_directory" type="button" value="..."> -->
			</span>
			<div id="converter_panel_target_directory_warning" style="color: red">
				&nbsp;
			</div>
		</div>

		<div class="converter_panel_widget">
			Input Files:
			<div id="converter_panel_files" class="converter_panel_list">
				<div>file 1</div>
				<div>file 2</div>
				<div>file 3</div>
				<div>file 4</div>
				<div>file 5</div>
				<div>file 6</div>
				<div>file 7</div>
				<div>file 8</div>
			</div>
		</div>

		<br>

		<div class="converter_panel_widget">
			Choose a Converter:
			<div class="selection_buttons">

				<input type="radio" id="selection_converter_version_1_7" 
					name="selection_converter_version" value="all">
				<label for="selection_converter_version_1_7" class="left">
					<span class="title">PotreeConverter 1.7</span>
					<ul>
						<li>Free</li>
					</ul>
				</label>

				<input type="radio" id="selection_converter_version_2_0" 
					name="selection_converter_version" value="false" checked>
				<label for="selection_converter_version_2_0" class="right" >
					<span class="title">PotreeConverter 2.0</span>
					<ul>
						<li>Free for non-commercial and non-government</li>
						<li>Three month trial period</li>
						<li>See <a href="https://github.com/potree/PotreeConverter" target="_blank">PotreeConverter at GitHub</a></li>
					</ul>
				</label>

			</div>
		</div>

		<p>
			<span style="display: flex">
				<span style="flex-grow: 1"></span>
				<input type="button" value="Start Conversion" id="converter_panel_start"/>
				<span style="width:1em"></span>
				<input type="button" value="Cancel" id="converter_panel_cancel"/>
			</span>
			
		</p>

	</span>

	<script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>

	<script src="./libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="./libs/spectrum/spectrum.js"></script>
	<script src="./libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="./libs/three.js/build/three.min.js"></script>
	<script src="./libs/three.js/extra/lines.js"></script>
	<script src="./libs/other/BinaryHeap.js"></script>
	<script src="./libs/tween/tween.min.js"></script>
	<script src="./libs/d3/d3.js"></script>
	<script src="./libs/proj4/proj4.js"></script>
	<script src="./libs/openlayers3/ol.js"></script>
	<script src="./libs/i18next/i18next.js"></script>
	<script src="./libs/jstree/jstree.js"></script>
	<script src="./libs/potree/potree.js"></script>
	<script src="./libs/plasio/js/laslaz.js"></script>

		<script>
		let elSplatQuality = $("#converter_choice");
		elSplatQuality.selectgroup({title: "Converter Choice"});

		elSplatQuality.find("input").click( (e) => {
			console.log(e.target.value);
			// if(e.target.value === "standard"){
			// 	this.viewer.useHQ = false;
			// }else if(e.target.value === "hq"){
			// 	this.viewer.useHQ = true;
			// }
		});
	</script>
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area"></div>
		<div id="potree_sidebar_container"> </div>
	</div>


		<script>

		{
			// open links in the standard browser instead of electron
			// see https://github.com/electron/electron/issues/1344
			const shell = require('electron').shell;
			$(document).on('click', 'a[href^="http"]', function(event) {
				event.preventDefault();
				shell.openExternal(this.href);
			});
		}

		function loadDroppedPointcloud(cloudjsPath){
			const folderName = cloudjsPath.replace(/\\/g, "/").split("/").reverse()[1];

			Potree.loadPointCloud(cloudjsPath).then(e => {
				let pointcloud = e.pointcloud;
				let material = pointcloud.material;

				pointcloud.name = folderName;

				viewer.scene.addPointCloud(pointcloud);

				let hasRGBA = pointcloud.getAttributes().attributes.find(a => a.name === "rgba") !== undefined
				if(hasRGBA){
					pointcloud.material.activeAttributeName = "rgba";
				}else{
					pointcloud.material.activeAttributeName = "color";
				}

				material.size = 1;
				material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

				viewer.zoomTo(e.pointcloud);
			});
		}

		function createPlaceholder(aabb){
			console.log("create placeholder");
			console.log(aabb);

			const placeholder = {};

			const node = new THREE.Object3D();
			
			const min = new THREE.Vector3(...aabb.min);
			const max = new THREE.Vector3(...aabb.max);
			const center = new THREE.Vector3(
				(min.x + max.x) / 2,
				(min.y + max.y) / 2,
				(min.z + max.z) / 2,
			);
			const radius = center.distanceTo(max);
			node.boundingSphere = new THREE.Sphere(center, radius);

			const text = new Potree.TextSprite("");
			text.position.copy(center);
			const textScale = radius / 5;
			text.material.depthTest = false;
			text.material.depthWrite = false;
			text.material.transparent = true;
			text.material.opacity = 0.7;
			text.scale.set(textScale, textScale, textScale);
			viewer.scene.scene.add(text);

			const box = new THREE.Box3(min, max);
			const box3 = new Potree.Box3Helper(box, 0xff0000);
			viewer.scene.scene.add(box3);

			const camera = viewer.scene.getActiveCamera();
			viewer.zoomTo(node);

			placeholder.text = text;
			placeholder.box = box3;
			placeholder.remove = () => {
				viewer.scene.scene.remove(box3);
				viewer.scene.scene.remove(text);
			};


			return placeholder;
		}

		function convert_17(inputPaths, chosenPath, pointcloudName){
			let message = `Starting conversion.<br>
			input: ${inputPaths}<br>
			output: ${chosenPath}`;
			viewer.postMessage(message, {duration: 15000});

			const { spawn } = require('child_process');
			const converter = spawn('./libs/PotreeConverter/PotreeConverter.exe', [
				...inputPaths,
				"-o", chosenPath,
				"--overwrite"
			]);

			let placeholder = null;
			converter.stdout.on('data', (data) => {
				console.log("==");
				console.log(`stdout: ${data}`);

				const string = new TextDecoder("utf-8").decode(data);

				if(!placeholder){ // match for AABB
					const regexp = /(.*AABB): ({[.\s\S]*?})/g;
					const matches = string.matchAll(regexp);
						
					for (const match of matches) {
						try{
							const name = match[1];
							const value = match[2];
							const aabb = JSON.parse(match[2]);
							console.log(aabb);

							if(name === "cubicAABB"){
								placeholder = createPlaceholder(aabb);
							}
						}catch(e){
							console.error(match[0]);
							console.error(e);
						}
					}
				}

				window.placeholder = placeholder;

				if(placeholder){ // match for progress
					const regexp = /INDEXING: ([\w\.]*) of ([\w\.]*) processed/g;
					const matches = string.matchAll(regexp);

					for(const match of matches){

						const processed = parseInt(match[1].replace(/\D/g,''));
						const total = parseInt(match[2].replace(/\D/g,''));
						const percent = parseInt(100 * (processed / total));
						
						const text = `${percent}%`;
						placeholder.text.setText(text);
					}
				}

			});

			converter.stderr.on('data', (data) => {
				console.log("==");
				console.error(`stderr: ${data}`);
			});

			converter.on('close', (code) => {
				console.log(`child process exited with code ${code}`);

				const cloudJS = `${chosenPath}/cloud.js`;
				console.log("now loading point cloud: " + cloudJS);

				if(placeholder){
					placeholder.remove();
				}

				let message = `conversion finished, now loading ${cloudJS}`;
				viewer.postMessage(message, {duration: 15000});

				Potree.loadPointCloud(cloudJS, pointcloudName, function(e){
					viewer.scene.addPointCloud(e.pointcloud);

					let material = e.pointcloud.material;
					material.size = 1;
					material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

					//viewer.zoomTo(e.pointcloud);
				});
			});
		}

		function convert_20(inputPaths, chosenPath, pointcloudName){
			let message = `Starting conversion.<br>
			input: ${inputPaths}<br>
			output: ${chosenPath}`;
			viewer.postMessage(message, {duration: 15000});

			const { spawn } = require('child_process');
			const converter = spawn('./libs/PotreeConverter2/Converter.exe', [
				...inputPaths,
				"-o", chosenPath
			]);

			let placeholder = null;
			converter.stdout.on('data', (data) => {
				console.log("==");
				console.log(`stdout: ${data}`);

				const string = new TextDecoder("utf-8").decode(data);

				if(!placeholder){ // match for AABB
					const regexp = /(.*AABB): ({[.\s\S]*?})/g;
					const matches = string.matchAll(regexp);
						
					for (const match of matches) {
						try{
							const name = match[1];
							const value = match[2];
							const aabb = JSON.parse(match[2]);
							console.log(aabb);

							if(name === "cubicAABB"){
								placeholder = createPlaceholder(aabb);
							}
						}catch(e){
							console.error(match[0]);
							console.error(e);
						}
					}
				}

				window.placeholder = placeholder;

				if(placeholder){ // match for progress

					let regexp = /\[(\d+)%,/g;

					const matches = string.replace(/'/g, "").matchAll(regexp);

					for(const match of matches){
						const percent = parseInt(match[1].replace(/\D/g,''));
						
						const text = `${percent}%`;
						placeholder.text.setText(text);
					}

				}

			});

			converter.stderr.on('data', (data) => {
				console.log("==");
				console.error(`stderr: ${data}`);
			});

			converter.on('close', (code) => {
				console.log(`child process exited with code ${code}`);

				const cloudJS = `${chosenPath}/metadata.json`;
				console.log("now loading point cloud: " + cloudJS);

				if(placeholder){
					placeholder.remove();
				}

				let message = `conversion finished, now loading ${cloudJS}`;
				viewer.postMessage(message, {duration: 15000});

				Potree.loadPointCloud(cloudJS).then(e => {
					let pointcloud = e.pointcloud;
					let material = pointcloud.material;

					pointcloud.name = pointcloudName;

					let hasRGBA = pointcloud.getAttributes().attributes.find(a => a.name === "rgba") !== undefined
					if(hasRGBA){
						pointcloud.material.activeAttributeName = "rgba";
					}else{
						pointcloud.material.activeAttributeName = "color";
					}

					material.size = 1;
					material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

					viewer.scene.addPointCloud(pointcloud);
					//viewer.fitToScreen();
					viewer.zoomTo(e.pointcloud);
				});

			});
		}

		async function doConversion(inputPaths, suggestedDirectory, suggestedName){

			const fs = require("fs");
			const npath = require("path");
			const fsp = fs.promises;

			console.log("Open converter panel");
			console.log("input paths: ", inputPaths);
			console.log("suggested directory: ", suggestedDirectory);
			console.log("suggested name: ", suggestedName);

			let i = 1; 
			let suggestedPath = `${suggestedDirectory}/${suggestedName}`;
			while(fs.existsSync(suggestedPath)){
				suggestedPath = `${suggestedDirectory}/${suggestedName}_${i}`;
				i++;
			}


			let elPanel = document.getElementById("converter_panel");
			let elFiles = document.getElementById("converter_panel_files");
			let elTargetDir = document.getElementById("converter_panel_target_directory");
			let elTargetDirWarning = document.getElementById("converter_panel_target_directory_warning");
			// let elPickTargetDir = document.getElementById("converter_panel_pick_target_directory");
			let elCancel = document.getElementById("converter_panel_cancel");
			let elStart = document.getElementById("converter_panel_start");

			elPanel.style.display = "block";

			elTargetDir.value = suggestedPath;
			elFiles.innerHTML = inputPaths.map(file => `<div>${file}</div>`).join("\n");

			let checkTarget = () => {
				let targetDir = elTargetDir.value;

				try{
					let stat = fs.lstatSync(targetDir);

					if(stat.isDirectory()){
						let msg = `WARNING: the target folder already exists. Contents may be overriden.`;
						elTargetDirWarning.innerHTML = msg;
					}else{
						elTargetDirWarning.innerHTML = "&nbsp;";
					}
				}catch(e){
					elTargetDirWarning.innerHTML = "&nbsp;";
				}
			};

			elTargetDir.oninput = () => {
				checkTarget();
			};

			// elPickTargetDir.onclick = () => {
			// 	const dialog = require('electron').remote.dialog;
			// 	const chosenPath = dialog.showSaveDialogSync(null, {
			// 		title: "Chose Conversion Directory",
			// 		defaultPath: suggestedPath,
			// 		buttonLabel: "Select",
			// 		filters: [],
			// 		properties: ["openDirectory ", "promptToCreate", "createDirectory"],
			// 	});

			// 	if(chosenPath === undefined){
			// 		// keep old path
			// 	}else{
			// 		elTargetDir.value = chosenPath;
			// 	}

			// 	checkTarget();
			// };

			elCancel.onclick = () => {
				elPanel.style.display = "none";
			};

			elStart.onclick = () => {
				console.log("start conversion!!");

				let el_1_7 = document.getElementById("selection_converter_version_1_7");
				let el_2_0 = document.getElementById("selection_converter_version_2_0");

				let targetDirectory = elTargetDir.value;

				console.log("targetDirectory", targetDirectory);
				console.log("inputPaths", inputPaths);

				elPanel.style.display = "none";

				if(el_1_7.checked){
					console.log("convert 1.7");
					convert_17(inputPaths, targetDirectory, suggestedName);
				}else if(el_2_0.checked){
					// console.log("convert 2.0");
					convert_20(inputPaths, targetDirectory, suggestedName);
				}


			};
		}

		function showDropzones(){
			let element = document.getElementById("pointcloud_file_dropzone");

			element.style.display = "block";
		}

		function hideDropzones(){
			let element = document.getElementById("pointcloud_file_dropzone");

			element.style.display = "none";
		}

		function dragEnter(e) {
			e.dataTransfer.dropEffect = 'copy';

			e.preventDefault();
			e.stopPropagation();

			console.log("enter");

			showDropzones();

			return false;
		}

		function dragOver(e){
			e.preventDefault();
			e.stopPropagation();

			showDropzones();

			return false;
		}

		function dragLeave(e){

			e.preventDefault();
			e.stopPropagation();

			hideDropzones();

			return false;
		}

		async function dropHandler(event){
			// console.log(event);
			event.preventDefault();
			event.stopPropagation();

			hideDropzones();

			let u = event.clientX / document.body.clientWidth;

			console.log(u);

			const cloudJsFiles = [];
			const lasLazFiles = [];

			let suggestedDirectory = null;
			let suggestedName = null;

			for(let i = 0; i < event.dataTransfer.items.length; i++){
				let item = event.dataTransfer.items[i];

				if(item.kind !== "file"){
					continue;
				}

				let file = item.getAsFile();
				let path = file.path;

				const fs = require("fs");
				const fsp = fs.promises;
				const np = require('path');

				const whitelist = [".las", ".laz"];

				let isFile = fs.lstatSync(path).isFile();

				if(isFile && path.indexOf("cloud.js") >= 0){
					cloudJsFiles.push(file.path);
				}else if(isFile && path.indexOf("metadata.json") >= 0){
					cloudJsFiles.push(file.path);
				}else if(isFile){
					const extension = np.extname(path).toLowerCase();

					if(whitelist.includes(extension)){
						lasLazFiles.push(file.path);

						if(suggestedDirectory == null){
							suggestedDirectory = np.normalize(`${path}/..`);
							suggestedName = np.basename(path, np.extname(path)) + "_converted";
						}
					}
				}else if(fs.lstatSync(path).isDirectory()){
					// handle directory

					console.log("start readdir!");
					const files = await fsp.readdir(path);

					console.log("readdir done!");

					for(const file of files){
						const extension = np.extname(file).toLowerCase();

						if(whitelist.includes(extension)){
							lasLazFiles.push(`${path}/${file}`);

							if(suggestedDirectory == null){
								suggestedDirectory = np.normalize(`${path}/..`);
								suggestedName = np.basename(path, np.extname(path)) + "_converted";
							}

						}else if(file.toLowerCase().endsWith("cloud.js")){
							cloudJsFiles.push(`${path}/${file}`);
						}else if(file.toLowerCase().endsWith("metadata.json")){
							cloudJsFiles.push(`${path}/${file}`);
						}

					};

					// lasLazFiles.push(path);

				}
			}

			// console.log(cloudJsFiles);
			// console.log(lasLazFiles);

			if(lasLazFiles.length > 0){
				doConversion(lasLazFiles, suggestedDirectory, suggestedName);
			}

			for(const cloudjs of cloudJsFiles){
				loadDroppedPointcloud(cloudjs);
			}

			return false;
		};

		let elBody = document.body;

		elBody.addEventListener("dragenter", dragEnter, false);
		elBody.addEventListener("dragover", dragOver, false);
		elBody.addEventListener("dragleave", dragLeave, false);
		elBody.addEventListener("drop", dropHandler, false);
	
		let elRenderArea = document.getElementById("potree_render_area");
		let viewerArgs = {
			noDragAndDrop: true,
		};
		window.viewer = new Potree.Viewer(elRenderArea, viewerArgs);
		
		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(3*1000*1000);
		viewer.setMinNodeSize(0);
		viewer.loadSettingsFromURL();
		
		viewer.setDescription("");
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			$("#menu_filters").next().show();
			viewer.toggleSidebar();
		});

		// load a file from your disc or USB drive:
		//Potree.loadPointCloud("C:/dev/workspaces/potree/develop/pointclouds/lion_takanawa/cloud.js", "Point Cloud Name", function(e){
		
		//Potree.loadPointCloud("http://5.9.65.151/mschuetz/potree/resources/pointclouds/archpro/heidentor/cloud.js", "Point Cloud Name", function(e){
		//	viewer.scene.addPointCloud(e.pointcloud);
		//	e.pointcloud.position.z = 0;
		//	let material = e.pointcloud.material;
		//	material.size = 1;
		//	material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

		//	viewer.scene.view.position.set(13.856734292740617, -9.125174923658731, 14.563928417406354);
		//	viewer.scene.view.lookAt(-3.5482630104475366, 2.728596783815762, 6.1406044783018725);
		//});
		
		

		//Potree.loadPointCloud("C:/dev/pointclouds/ot_35120C7102A_1/cloud.js", "CA13", e => {
		////Potree.loadPointCloud("../pointclouds/C/dev/pointclouds/test/cloud.js", "sigeom.sa", e => {
		//	let scene = viewer.scene;
		//	let pointcloud = e.pointcloud;
		//	
		//	let material = pointcloud.material;
		//	material.size = 3;
		//	material.pointSizeType = Potree.PointSizeType.FIXED;
		//	material.pointColorType = Potree.PointColorType.SOURCE;
		//	material.shape = Potree.PointShape.SQUARE;
		//	
		//	scene.addPointCloud(pointcloud);
		//	
		//	scene.view.position.set(693195.575, 3915628.878, 472.872);
		//	scene.view.lookAt(693747.110, 3916033.332, 33.996);
		//});

		
		// viewer.onGUILoaded(() => {
		// 	let message = `
		// 	Welcome to Potree Desktop.<br>
		// 	<p>
		// 	This portable version can be used to load <a href="https://github.com/potree/PotreeConverter", target="_blank"> converted point clouds</a>
		// 	directly from disk. Just drag & drop a cloud.js file, or it's parent folder, into this window.
		// 	</p>

		// 	<p>
		// 	You can set up a default scene by modifying the index.html file in the potree desktop folder. 
		// 	</p>
		// 	`;

		// 	//viewer.postMessage(message);
		// 	viewer.postMessage(message, {duration: 15000});
		// });

		window.addEventListener('error', (e) => {
			//console.log(e);
			viewer.postError(e.error.message);
		});

		
		
	</script>


	</body>
</html>
